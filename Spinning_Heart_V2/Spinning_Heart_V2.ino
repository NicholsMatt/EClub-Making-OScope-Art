/*
 *      Tek Block letter XY display with spin effect
 *      Created 31 Mar 2013 by Alan Wolke
 *      uses PORTs and R-2R ladder - note Y limited to 0-63, 6-bit
 *      R2R time constant 2.7k*10n or 3.9k * 6.8n
 *      works well with scope set for 0.5V/div XY mode
 */


#define FIGURE_DELAY	100  // trace delay in uS. Adjust as desired.
#define NUM_POINTS	101   // number of XY points in figure


// x coords on port d
byte x_points[NUM_POINTS] = {	
  127.566888249050,127.693847910442,128.567418994845,130.859947141098,135.101956030022,141.627410325645,150.536760638331,161.681142763525,174.669210852264,188.896058717073,203.591706133388,217.884874435031,230.876404522519,241.715803142602,249.674117485714,254.206659379061,255,251.999053804667,245.411841474904,235.691507999127,223.497196163909,209.637257006185,194.999849187500,180.477098595255,166.889557835318,154.917671954719,145.046324764563,137.527366034824,132.363408539565,129.314279426356,127.925482836339,127.576061265322,127.541507787550,127.066035003190,125.437669693587,122.059389441358,116.509871473997,108.588353093424,98.3395242538735,86.0561591758333,72.2591857406148,57.6569108385794,43.0869864143554,29.4462478831076,17.6146456483289,8.38002429425536,2.37043490638406,0,1.43314712918475,6.57039383230944,15.0569489787401,26.3133650329493,39.5855135536150,54.0094375985794,68.6853130589810,82.7539442837558,95.4689996656753,106.258579699583,114.770668774284,120.898466920821,124.783399784172,126.795603193669,127.493694352988,127.567494766597,127.768895006212,128.837112054500,131.425091486890,136.033704360031,142.959691514871,152.262078357553,163.750130909210,176.993996632311,191.357143435648,206.047758713069,220.184571652162,232.871268140764,243.272894037322,250.687458516041,254.606371154601,254.758336777140,251.132802404332,243.980869728204,233.793591904686,221.259586083247,207.205733263957,192.526240485791,178.106372783942,164.747631655214,153.101021086284,143.614313714545,136.497973539416,131.712720047058,128.979781018754,127.812850786325,127.568828693951,127.512732529275,126.890913790862,125.005959138270,121.286511561680,115.345699183494,107.022878570813};

// y coords on port b - limited to 0-63 with map function later
byte y_points[NUM_POINTS] = { 
  193.950961965293,195.741262473594,200.902548609613,208.830954289339,218.599946536792,229.068928598793,239.014431915495,247.266691960143,252.834079438608,255,253.381131932452,247.941583191184,238.963851512937,226.983426573471,212.698613643668,196.870017355427,180.224734442122,163.378648120456,146.786622807537,130.725483688588,115.309236363164,100.530900948459,86.3213883491845,72.6136198925334,59.3998827703449,46.7721902862282,34.9388266749146,24.2146935417590,14.9877767724152,7.66822866348157,2.62952018965306,0.152384948719249,0.381659694068139,3.30375345272392,8.74876849870893,16.4168947910906,25.9243629403900,36.8607165668238,48.8470652525875,61.5846790568709,74.8848586990610,88.6742204713035,102.973851790609,117.855506775987,133.382326493357,149.544741100298,166.203670248952,183.052583202352,199.607434904422,215.229309116528,229.179401572736,240.700572914364,249.114956266243,253.923799790351,254.894435452695,252.120264653596,246.042861639168,237.430293897478,227.311836660870,216.875527135276,207.340527638483,199.820206333451,195.193586386230,194.002067482323,196.385164824016,202.063876942640,210.373917645156,220.344348405723,230.811093274603,240.550279808751,248.413970136921,253.450946521260,254.997746913734,252.729700271774,246.667586814121,237.141857865228,224.722157591354,210.124352565804,194.109772633438,177.391587150235,160.561226804668,144.043895506341,128.087156433361,112.781145680453,98.1040259127530,83.9826009940142,70.3561132624318,57.2313815734533,44.7195221419206,33.0481257443538,22.5473023076831,13.6126713898898,6.65239224587161,2.02802885864845,0,0.687434999253298,4.04962179119005,9.89235898530020,17.8980786507885,27.6743564982372,38.8121040147671};

// some initial starting values...                                      
byte x_min = 50;
byte x_max = 50;
byte x_mid = 50;
byte x_half;

void setup()
{
  DDRD = B11111111; //initialize PORTs for writing
  DDRB = B00111111;

  byte t;
  for(t = 0; t < NUM_POINTS; t++)
  {
    y_points[t] = map(y_points[t],0,255,0,63); //re-map Y points to 6 bits
  }

  for(t=0; t < NUM_POINTS; t++) //get min, max and mid values of X
  {
    x_min = min(x_min, x_points[t]);
    x_max = max(x_max, x_points[t]);
  }
  x_mid = (x_max + x_min)/2;
  x_half = (x_max - x_min)/2;
}

void loop()
{
  byte t;
  byte sx;
  float p;
  byte flip;
  for(p=0; p<314; p++)
  {
    sx = ( sin(p/100) * x_half);                // half-sine for X scaling to simulate rotation
    for(t = 0; t < NUM_POINTS; t++)		// run through the X points
    {
      PORTD = map(x_points[t], x_min, x_max, x_mid-sx, x_mid+sx); // scale X with half-sine about mid point
      PORTB = y_points[t];
      delayMicroseconds(FIGURE_DELAY);		// wait FIGURE_DELAY microseconds
    }
  }
  flip = x_min; // flip X min and max values so next map is reversed
  x_min = x_max;
  x_max = flip;
}
